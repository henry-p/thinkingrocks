---
import "../styles/global.css";
import { OpenPanelComponent } from "@openpanel/astro";
import { OPENPANEL, SITE } from "../lib/site";

type Props = {
  title?: string;
  description?: string;
  image?: string;
  imageAlt?: string;
  type?: "website" | "article";
  xPlatformCard?: "summary" | "summary_large_image";
};

const {
  title,
  description,
  image,
  imageAlt,
  type = "website",
  xPlatformCard = "summary_large_image",
} = Astro.props;
const pageTitle = title ? `${title} · ${SITE.title}` : SITE.title;
const pageDescription = description?.trim() || SITE.description || SITE.title;
const siteUrl = Astro.site ?? new URL(SITE.url);
const canonicalUrl = import.meta.env.DEV
  ? new URL(`${Astro.url.pathname}${Astro.url.search}`, siteUrl)
  : Astro.url;
const imageBase = image ?? SITE.socialImage ?? SITE.profileImage;
const useSocialImage = !image && imageBase === SITE.socialImage && SITE.socialImageVersion;
const imageUrl = new URL(
  useSocialImage ? `${SITE.socialImage}?v=${SITE.socialImageVersion}` : imageBase,
  siteUrl
).href;
const imageDescription = imageAlt ?? pageTitle;
const openpanelApiUrl = OPENPANEL.apiUrl ? OPENPANEL.apiUrl.replace(/\/+$/, "") : "";
const openpanelCdnUrl = OPENPANEL.cdnUrl ? OPENPANEL.cdnUrl.replace(/\/+$/, "") : "";
const hasOpenpanel = Boolean(openpanelApiUrl && OPENPANEL.clientId);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Source+Sans+3:wght@400;500;700&family=Spectral:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <title>{pageTitle}</title>
    {pageDescription && <meta name="description" content={pageDescription} />}

    <link rel="canonical" href={canonicalUrl} />
    <link rel="icon" href="/favicon.png" />

    <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml" />
    <link rel="image_src" href={imageUrl} />

    <!-- Open Graph -->
    <meta property="og:site_name" content={SITE.title} />
    <meta property="og:type" content={type} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:url" content={canonicalUrl.toString()} />
    <meta property="og:image" content={imageUrl} />
    <meta property="og:image:alt" content={imageDescription} />

    <!-- X/Twitter -->
    <meta name="twitter:card" content={xPlatformCard} />
    <meta name="twitter:site" content={SITE.xPlatformHandle} />
    <meta property="twitter:domain" content={siteUrl.hostname} />
    <meta property="twitter:url" content={canonicalUrl.toString()} />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={imageUrl} />
    <meta name="twitter:image:alt" content={imageDescription} />

    <script>
      window.MathJax = {
        tex: {
          inlineMath: [["$", "$"], ["\\(", "\\)"]],
          displayMath: [["$$", "$$"], ["\\[", "\\]"]],
          macros: {
            Q: "\\mathbb{Q}",
            C: "\\mathbb{C}",
          },
        },
      };
    </script>
    <script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    {hasOpenpanel && (
      <OpenPanelComponent
        clientId={OPENPANEL.clientId}
        apiUrl={openpanelApiUrl}
        cdnUrl={openpanelCdnUrl || undefined}
        trackScreenViews={true}
        trackOutgoingLinks={true}
        trackAttributes={true}
      />
    )}
  </head>

  <body>
    <a
      href="#content"
      class="sr-only focus:not-sr-only focus:fixed focus:left-4 focus:top-4 focus:z-50 focus:rounded-md focus:bg-white focus:px-3 focus:py-2 focus:text-sm focus:font-medium focus:shadow dark:focus:bg-slate-900"
    >
      Skip to content
    </a>

    <div class="pointer-events-none fixed inset-x-0 top-0 z-0 h-80 bg-gradient-to-b from-white to-cream dark:from-[#162033] dark:to-slate-950"></div>

    <div class="relative z-10 min-h-screen flex flex-col">
      <header
        class="site-header sticky top-0 z-40 border-b border-slate-900/10 bg-white/85 shadow-sm backdrop-blur transition-all duration-300 ease-out motion-reduce:transition-none dark:border-white/10 dark:bg-slate-950/80"
      >
        <div
        class="site-header-inner mx-auto flex max-w-[34rem] items-center justify-between gap-4 px-3 py-4 transition-all duration-300 ease-out motion-reduce:transition-none sm:px-4"
      >
          <a href="/" class="site-brand flex items-center gap-2 text-base font-bold tracking-tight transition-all duration-300 ease-out">
            <img src="/favicon.png" alt="" class="site-brand-logo h-6 w-6 transition-all duration-300 ease-out" />
            <span>{SITE.title}</span>
          </a>

          <nav class="flex items-center gap-4 text-sm text-slate-600 dark:text-slate-300">
            <a href="/posts" class="hover:text-slate-900 hover:underline dark:hover:text-slate-100">Posts</a>
            <a href="/about" class="hover:text-slate-900 hover:underline dark:hover:text-slate-100">About</a>
          </nav>
        </div>
      </header>

      <div class="mx-auto w-full max-w-[22rem] flex-1 px-2 py-8 sm:max-w-[34rem] sm:px-4">
        <main id="content" class="min-w-0 w-full">
          <slot />
        </main>
      </div>

      <footer class="mt-auto">
        <div class="mx-auto w-full px-3 py-10 text-center text-sm text-slate-400 dark:text-slate-500 sm:px-4">
          © {new Date().getFullYear()}{" "}
          <a href="/about" class="text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300">
            {SITE.author}
          </a>{" "}
          |{" "}
          <a href="/privacy" class="hover:text-slate-600 dark:hover:text-slate-300">
            Privacy
          </a>
        </div>
      </footer>
    </div>

    <script is:inline>
      (() => {
        const root = document.documentElement;
        const onThreshold = 24;
        const offThreshold = 0;

        let isScrolled = false;
        let rafId = 0;

        const apply = () => {
          rafId = 0;

          const y = window.scrollY || 0;

          if (!isScrolled && y > onThreshold) {
            isScrolled = true;
            root.classList.add("is-scrolled");
            return;
          }

          if (isScrolled && y <= offThreshold) {
            isScrolled = false;
            root.classList.remove("is-scrolled");
          }
        };

        const onScroll = () => {
          if (rafId) return;
          rafId = window.requestAnimationFrame(apply);
        };

        apply();
        window.addEventListener("scroll", onScroll, { passive: true });
      })();
    </script>
    <script is:inline>
      (() => {
        const { pathname, search, hash } = window.location;
        if (pathname.length <= 1 || !pathname.endsWith("/")) return;

        const normalized = pathname.replace(/\/+$/, "");
        window.location.replace(normalized + search + hash);
      })();
    </script>
  </body>
</html>
