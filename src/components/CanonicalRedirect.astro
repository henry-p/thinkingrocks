---
import { SITE } from "../lib/site";

const { target, title, description, image, imageAlt, type, xPlatformCard } = Astro.props;
if (typeof target !== "string") {
  throw new Error("CanonicalRedirect requires a string target.");
}

const pageTitle = title ? `${title} Â· ${SITE.title}` : SITE.title;
const pageDescription = description?.trim() || SITE.description || SITE.title;
const siteUrl = Astro.site ?? new URL(SITE.url);
const canonicalUrl = new URL(target, siteUrl).toString();
const imageBase = image ?? SITE.socialImage ?? SITE.profileImage;
const useSocialImage = imageBase === SITE.socialImage && SITE.socialImageVersion;
const imageUrl = new URL(
  useSocialImage ? `${SITE.socialImage}?v=${SITE.socialImageVersion}` : imageBase,
  siteUrl
).href;
const imageDescription = imageAlt ?? pageTitle;
const ogType = type ?? "website";
const twitterCard = xPlatformCard ?? "summary_large_image";
const shouldRenderSocial = Boolean(title || description || image || imageAlt);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="refresh" content={`0;url=${target}`} />
    <link rel="canonical" href={canonicalUrl} />
    {shouldRenderSocial && (
      <>
        <meta property="og:site_name" content={SITE.title} />
        <meta property="og:type" content={ogType} />
        <meta property="og:title" content={pageTitle} />
        <meta property="og:description" content={pageDescription} />
        <meta property="og:url" content={canonicalUrl} />
        <meta property="og:image" content={imageUrl} />
        <meta property="og:image:alt" content={imageDescription} />

        <meta name="twitter:card" content={twitterCard} />
        <meta name="twitter:site" content={SITE.xPlatformHandle} />
        <meta property="twitter:domain" content={siteUrl.hostname} />
        <meta property="twitter:url" content={canonicalUrl} />
        <meta name="twitter:title" content={pageTitle} />
        <meta name="twitter:description" content={pageDescription} />
        <meta name="twitter:image" content={imageUrl} />
        <meta name="twitter:image:alt" content={imageDescription} />
      </>
    )}
    <script is:inline>
      window.location.replace({JSON.stringify(target)} + window.location.search + window.location.hash);
    </script>
  </head>
  <body>
    <a href={target}>Continue to {target}</a>
  </body>
</html>
