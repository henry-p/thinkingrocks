---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { formatDate } from "../../lib/format";
import { getAllPosts, getPostBySlug } from "../../lib/posts";
import { SITE } from "../../lib/site";

export function getStaticPaths() {
  return getAllPosts().map((post) => ({ params: { slug: post.slug } }));
}

const slug = Astro.params.slug;
if (!slug) throw new Error("Missing slug param");

const post = getPostBySlug(slug);
if (!post) throw new Error(`Post not found: ${slug}`);

const PostContent = post.module.Content as any;
const subtitle = typeof post.module.frontmatter?.subtitle === "string" ? post.module.frontmatter.subtitle : undefined;
const primaryImage =
  typeof post.module.frontmatter?.image === "string"
    ? post.module.frontmatter.image
    : SITE.profileImage;
const primaryImageAlt =
  typeof post.module.frontmatter?.imageAlt === "string"
    ? post.module.frontmatter.imageAlt
    : primaryImage === SITE.profileImage
      ? SITE.author
      : post.title;
const description = subtitle ?? SITE.description ?? post.title;
---

<BaseLayout
  title={post.title}
  description={description}
  type="article"
  image={primaryImage}
  imageAlt={primaryImageAlt}
  xPlatformCard={SITE.postXPlatformCard}
>
  <article class="space-y-6">
    <header class="post-header space-y-3">
      <h1 class="text-[32px] font-bold leading-[36px] tracking-normal text-slate-900 dark:text-slate-100">{post.title}</h1>
      {subtitle && <h2 class="text-[18px] leading-[24px] text-slate-600 dark:text-slate-300">{subtitle}</h2>}
      <a href="/about" class="group flex items-center gap-3 text-sm text-slate-500 transition hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">
        <img src="/assets/profile.jpeg" alt={SITE.author} class="h-8 w-8 rounded-full object-cover" loading="lazy" />
        <div class="flex items-center gap-2">
          <span class="font-medium text-slate-700 transition group-hover:text-slate-900 dark:text-slate-200 dark:group-hover:text-slate-100">
            {SITE.author}
          </span>
          <span aria-hidden="true">Â·</span>
          <span>{formatDate(post.date)}</span>
        </div>
      </a>
    </header>

    <div class="prose prose-slate text-[17px] leading-[1.6] tracking-normal sm:text-[19px] prose-headings:tracking-tight prose-p:mt-0 prose-p:mb-5 prose-p:leading-[1.6] prose-p:tracking-normal prose-pre:rounded-lg prose-pre:bg-slate-900 prose-pre:text-slate-50 dark:prose-invert dark:prose-a:text-slate-100 dark:prose-pre:bg-slate-800">
      <PostContent />
    </div>
  </article>
</BaseLayout>
